# MIGRATION_RUNBOOK

Purpose

- Standard operating procedure for running DB migrations generated by the super-generator.

Pre-requisites

- Confirm `docs/templates/role-mapping.json` has required approvals.
- Ensure backup exists (see DB_BACKUP_RESTORE.md).
- Ensure CI smoke tests pass on staging.

Pre-checks (automated)

1. Run `node backend/scripts/check-integration.js --preflight`
2. Verify `migration-approval.yaml` exists for the migration id.
3. Verify required approvers signatures in `migration-approval.yaml`.

Execution (staging)

1. Create branch `auto/migration-<id>-<date>`
2. Apply migration on staging:
   - export $(cat .env.staging)
   - npx sequelize db:migrate --env staging
3. Run smoke tests:
   - npm run test:smoke

Execution (production) â€” manual confirmation required

1. Create backup (see DB_BACKUP_RESTORE.md)
2. Put system into maintenance mode
3. Run migration with production env:
   - export $(cat .env.production) && npx sequelize db:migrate --env production
4. Run post-checks:
   - Validate critical endpoints (health, login, sample flows)
5. Exit maintenance mode

Rollback

- Use the rollback SQL produced by generator or run `npx sequelize db:migrate:undo` per migration-step.
- Follow DB_BACKUP_RESTORE.md to restore data if needed.
